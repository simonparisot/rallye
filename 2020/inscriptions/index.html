<!DOCTYPE html>
<html>
<head>
	
	<meta charset="UTF-8">
	<title>Rallye d'Hiver 2019 - Paris</title>
	<link rel="stylesheet" type="text/css" href="main-style.css?v=1.0.3">
	<link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Roboto" rel="stylesheet">

	<script src="https://checkout.stripe.com/checkout.js"></script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62904031-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-62904031-1');
	</script>


</head>
<body>

	<header>
	
	</header>

	<section id="intro" class="active">

		<h1>Rallye d'Hiver 2020</h1>
		<h2>Inscriptions ouvertes !</h2>

		<!--div class="message">
			Le rallye d'hiver est lancé depuis le 21 décembre 2018 !<br>
			Si vous êtes déjà inscrits, rendez-vous sur <a href="https://rallyehiver.fr">rallyehiver.fr</a>.<br>
			Sinon, rejoignez-nous au plus vite ! Toutes les infos sont ci-dessous.<br>
			<span id="countdown">9 jours, 10 heures, 23 minute et 52 secondes</span><br>
		</div-->

		<p class="content-text">
			Le temps … Le temps …<br>
			Tout n’est que question de temps ! Le remonter ou le descendre, le perdre ou le passer, le temps d’une énigme ou d’un parcours, le tout est de le PRENDRE !<br><br>

			Nous voici à l’aube d’une nouvelle aventure concoctée par les Meltings Potes.<br>
			Et il est grand temps … d’inscrire votre équipe.<br><br>

			Le temps imparti est de 90 jours ou 2160 heures. Le 20 mars 2020, nous verrons qui a su maitriser … le temps.
		</p>

		<input type="submit" value="S'inscrire" class="button signupbutton" onclick="changecontent('signup'); return false;">
		<input type="submit" value="En savoir plus" class="button signupbutton" onclick="changecontent('what'); return false;">

	</section>

	<section id="signup">

		<h2>A vous de jouer</h2>

		<p class="content-text">
			Pour participer au Rallye d'Hiver 2020, formez une équipe (habituellement de 2 à 6 personnes), donnez lui un nom, désignez un chef d'équipe et réglez les frais d'inscription (26€ par équipe) par CB ou bien par chèque.
		</p>
		<form id="signup-form">
			
			<div class="guys">
				<input type="text" name="admin-name" id="admin-name" class="" placeholder="Prénom et nom du chef d'équipe" required><input type="mail" name="admin-mail" id="admin-mail" class="mailinput" placeholder="Son adresse e-mail" required><div id="addCo" onclick="ajouterCo();"><img src="res/addco.png"></div>
			</div>

			<div class="team">
				<input type="text" name="team-name" id="team-name" class="" placeholder="Nom de votre équipe" required><input type="submit" value="S'inscrire" class="button" onclick="signup(); return false;">
			</div>

		</form>
		<div id="form-error"></div>

		<p class="content-text">
			Les frais d'inscription, modiques (26€ par équipe, quelque soit le nombre de participants), servent essentiellement à rembourser les frais informatiques et à acheter des lots pour récompenser toutes les équipes lors d'un grand diner de cloture en avril.
		</p>

	</section>

	<section id="payment">

		<h1>Frais d'inscription</h1>

		<p class="content-text">
			Merci !<br>
			Votre équipe <span class="t-name"></span> est pré-inscrite.<br>
			Pour confirmer votre inscription, il vous suffit de régler vos frais d'inscription.
			Ceux-ci ne sont à régler qu'une seule fois par équipe et servent uniquement à couvrir les coûts d'organisation.
		</p>

		<input type="submit" value="Payer par CB" id="payCB-1" class="button paybutton">
		<!--input type="submit" value="Payer par chèque" id="payCheque" class="button chequebutton" onclick="changecontent('cheque'); return false;"-->

	</section>

	<section id="processing">

		<div class="lds-css ng-scope">
			<div style="width:100%;height:100%" class="lds-pacman"><div><div></div><div></div><div></div></div><div><div></div><div></div></div></div>
		</div>

	</section>
	
	<section id="cheque">
		
		<h2>Juste une dernière étape...</h2>
		<p class="content-text">
			Pour finaliser l'inscription de l'équipe <span class="t-name"></span>, merci d'envoyer un chèque à l'ordre et à l'adresse de :<br>
			<b>Association Jeux et Patrimoines<br>c/o RAFFY<br>15 rue des Feuillantines<br>75005 PARIS<br></b>
			Votre inscription sera validée dès que nous le recevrons. Nous vous le confirmerons sur votre adresse mail <span class="a-mail"></span>.<br><br>

			En attendant, nous vous donnons rendez-vous le 22 décembre pour le début du rallye !<br>
			D'ici là, n'hésitez pas à nous contacter par mail sur <b><a href="mailto:rallye.hiver.2020@gmail.com">rallye.hiver.2020@gmail.com</a></b>.<br><br>

			A très bientôt.
		</p>

		<input type="submit" value="Payer plutôt par CB" id="payCB-2" class="button paybutton">

	</section>

	<section id="allgood">
		<h2>Hourra !</h2>
		<p class="content-text">
			L'équipe <span class="t-name"></span> est maintenant inscrite au Rallye d'Hiver 2020 ! Vous avez reçu un mail sur <span class="a-mail"></span> pour confirmer le règlement des frais d'inscription.<br><br>

			Maintenant, rendez-vous le 22 décembre pour le lancement. Bien sûr d'ici là, n'hésitez pas à nous contacter par mail sur <b><a href="mailto:rallye.hiver.2020@gmail.com">rallye.hiver.2020@gmail.com</a></b>.<br><br>
			A très bientôt.
		</p><br><br>
		<img src="res/allgood.gif">
	</section>

	<section id="what">
		<h1>Le Rallye d'Hiver</h1>
		<h2>C'est quoi ?</h2>
		<div class="content-text">
			<p>Chaque année depuis plus de 50 ans, le Rallye d'Hiver propose à plusieurs centaines de participants de découvrir Paris autrement au travers d'énigmes et de jeux de piste.</p>

			<p>En pratique, des équipes de 2 à 6 personnes ont les trois mois d’hiver pour résoudre des énigmes qui les conduisent sur des lieux pittoresques et/ou insolites. Là, les équipes doivent suivre un parcours qui guide leur découverte du lieu. C’est l’occasion d’occuper les longues soirées d’hiver et les jours brumeux en se creusant la tête avec ses amis, sa familles ... ou ses collègues !</p>

			<p>Les frais d'inscription, modiques (26€ par équipe, quelque soit le nombre de participants), servent essentiellement à rembourser les frais informatiques et à acheter des lots pour récompenser toutes les équipes lors d'un grand diner de cloture en avril.</p>

			<p>Vous avez plus de questions ? Contactez les organisateurs par mail sur <b>rallye.hiver.2020@gmail.com</b>. Sinon, rassemblez votre équipe et ...</p>
			<input type="submit" value="Inscrivez-vous !" class="button signupbutton" onclick="changecontent('signup'); return false;">

		</div>

	</section>

	<script>
		
		function signup() {

			var error = "";
			adminmail = document.getElementById("admin-mail").value;	// ! GLOBALS
			adminname = document.getElementById("admin-name").value;	// ! GLOBALS
			teamname  = document.getElementById("team-name").value; 	// ! GLOBALS

			if 		(teamname == "") 	error = "Vous avez oublié le nom de l'équipe !";
		    else if (adminname == "") error = "Vous avez oublié le nom du chef d'équipe !";
		    else if (adminmail == "") error = "Vous avez oublié l'adresse mail du chef d'équipe";
		    else if (!validateEmail(adminmail)) error = "Attention ce n'est pas une adresse email valide";

			if (error == "") {

				// display loading animation ...
				changecontent("processing");
				
				var httpRequest = new XMLHttpRequest();

				// Coéquipiers
				var els = document.getElementsByClassName("coeq-mail");
				var coeq = '';
				Array.prototype.forEach.call(els, function(el) { coeq += el.value!='' ? el.value+',':''; });

				var data = {
					"team": teamname, 
					"leader": adminname, 
					"leadermail": adminmail
				};
				if (coeq != '') data['membersmails'] = coeq;
				
				httpRequest.onreadystatechange = function() {
				    if (httpRequest.readyState === 4) {
				    	if (httpRequest.status === 201) {
			                // display the team name in the other sections
			                var els = document.getElementsByClassName("t-name");
							Array.prototype.forEach.call(els, function(el) { el.innerHTML = teamname });
							var els = document.getElementsByClassName("a-mail");
							Array.prototype.forEach.call(els, function(el) { el.innerHTML = adminmail });

			                changecontent("payment");
			            } else {
			                document.getElementById("form-error").innerHTML = "Désolé, il y a eu un problème :(";
			            }
			        }
				};
				
				httpRequest.open('POST', 'https://g1t0ssi5cb.execute-api.eu-west-3.amazonaws.com/prod/signup', true);
				httpRequest.setRequestHeader('Content-Type', 'application/json');
				httpRequest.send(JSON.stringify(data));

			} else {
				document.getElementById("form-error").innerHTML = error;
			}
		}

		function validateEmail(txt) {
		    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
		    return re.test(String(txt).toLowerCase());
		}

		function ajouterCo () {
			var newNode = document.createElement('div');
			newNode.className = "guys";
			newNode.innerHTML = '<input type="text" name="coeq-name" placeholder="Prénom et nom du coéquipier"><input type="mail" name="coeq-mail" class="coeq-mail mailinput" placeholder="Son adresse e-mail"><div id="addCo" onclick="ajouterCo();"><img src="res/addco.png"></div>';
			var nodes = document.querySelectorAll(".guys");
			var lastNode = nodes[nodes.length- 1];

			var addCo = document.getElementById("addCo");
			lastNode.removeChild(addCo);


			lastNode.parentNode.insertBefore(newNode, lastNode.nextSibling);

		}

		function changecontent(page) {
			document.getElementsByClassName("active")[0].classList.remove("active")
			document.getElementById(page).classList.add("active")
		}

		function processPayment(token) {

			// display loading animation ...
			changecontent("processing");
			
		    var httpRequest = new XMLHttpRequest();
 			
			var data = {
				"token": token.id, 
				"email": token.email,
				"team": teamname
			};
			
			httpRequest.onreadystatechange = function() {
			    if (httpRequest.readyState === 4) {
			    	if (httpRequest.status === 200) {
		                // payment is processed, we can move to the confirmation page
		                changecontent("allgood");
		            } else {
		                // problem while processing payment
		                alert("Désolé, il y a eu un problème dans le traitement de votre paiement par CB. Aucune somme n'a été débitée. Je vous redirige vers le paiment par chèque comme plan B. Toutes les excuses de l'organisation.")
		                changecontent("cheque");
		            }
		        }
			};
			
			httpRequest.open('POST', 'https://g1t0ssi5cb.execute-api.eu-west-3.amazonaws.com/prod/payment', true);
			httpRequest.setRequestHeader('Content-Type', 'application/json');
			httpRequest.send(JSON.stringify(data));
		}

		// handle Checkout payment
		var handler = StripeCheckout.configure({
			key: 'pk_live_cCDQlUF3TzwDqP15EBt3JHcP',
			image: 'res/logo-small.jpg',
			locale: 'fr',
			token: function(token) {
				processPayment(token);
			}
		});

		var els = document.getElementsByClassName('paybutton');
		Array.prototype.forEach.call(els, function(el) {
			el.addEventListener('click', function(e) {
				
				// display checkout popup
				handler.open({
					name: "Rallye d'Hiver 2020",
					description: "Inscription " + teamname,
					currency: 'eur',
					amount: 2600,
					allowRememberMe: false,
					email: adminmail
				});

				e.preventDefault();
			});
		});

		window.addEventListener('popstate', function() {
			handler.close();
		});

	</script>

	<script>
		
		function updatecountdown() {

			var now = new Date().getTime();
			var distance = countDownDate - now;

			// If the count down is finished, redirect
			if (distance <= 0) {
				clearInterval(x);
				document.getElementById("countdown").innerHTML = "C'est parti !";
				window.location.href = "https://app.rallyehiver.fr";
				return;
			}else if(distance < 31000 && distance >= 30000) {
				document.getElementsByClassName('content-text')[0].style.display = 'none';
				document.getElementsByClassName('button')[0].style.display = 'none';
				document.getElementsByClassName('button')[1].style.display = 'none';
			}else if(distance < 21000 && distance >= 20000) {
				document.body.style.background = 'linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), #000 url("waldo.jpg") center/cover no-repeat fixed';
			}else if(distance < 16000 && distance >= 15000) {
				document.getElementById('intro').style.fontFamily = "'Indie Flower', sans-serif"
			}else if(distance < 11000 && distance >= 10000) {
				document.getElementsByClassName('message')[0].style.color = '#000';
				document.getElementsByClassName('message')[0].style.background = '#fff';
			}else if(distance < 6000 && distance >= 5000) {
				document.body.style.background = '#000 url("waldo.jpg") center/cover no-repeat fixed';
			}

			// Time calculations for days, hours, minutes and seconds
			var days = Math.floor(distance / (1000 * 60 * 60 * 24));
			var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
			var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
			var seconds = Math.floor((distance % (1000 * 60)) / (1000));

			// Display the result in the element
			var txt = '';
			if (days) txt += days + " jour" + (days>1 ? "s, ":", ");
			if (hours) txt += hours + " heure" + (hours>1 ? "s, ":", ");
			if (minutes) txt += minutes + " minute" + (minutes>1 ? "s et ":" et ");
			txt += seconds + " seconde" + (seconds>1 ? "s":"");

			document.getElementById("countdown").innerHTML = txt;

		}

		/* Pour lancer le compte à rebours
		var countDownDate = new Date("Dec 21, 2018 00:00:00").getTime();
		updatecountdown();
		var x = setInterval(function() {updatecountdown();}, 1000); */
	</script>

</body>
</html>